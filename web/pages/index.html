<!DOCTYPE html>
<html>

<head>
    <title>Shortlink Management</title>
    <link rel="stylesheet" type="text/css" media="screen" href="/manage/static/css/style.css" />
    <script src="/manage/static/lib/jquery.min.js" type="application/javascript"></script>
</head>

<body>
    <h2 style="text-align: center; margin-top: 40px;">CREATED LINKS</h2>
    <table style="width:100%" border="1" id="linktable">
        <tr>
            <th>RootLink</th>
            <th>ShortLink</th>
            <th>CreatedAt</th>
            <th>Accesses</th>
            <th>LastAccess</th>
            <th>Action</th>
        </tr>
    </table>

    <hr style="margin-top: 50px;"/>
    <center style="margin-top: 50px;">
        <h2>CREATE SHORT LINK</h2>
        <form id="fcreateedit">
            <p>LONG URL:</p>
            <input id="tblong" class="textbox" type="text" name="rooturl" autocomplete="off"/>
            <p>SHORT (leave empty for random one):</p>
            <input id="tbshort" class="textbox" type="text" name="shortlink" autocomplete="off"/>
            <br>
            <br>
            <input class="button" type="submit" value="CREATE">
        </form>
    </center>

    <script>
        const perSite = 1000;
        var site = 0;

        var links = [];

        function loadEntries() {
            $.ajax({
                method: 'GET',
                url: `/api/shortlinks?from=${site * perSite}&limit=${perSite}`,
                dataType: 'json',
                accepts: 'application/json',
                complete: function(res) {
                    links = res.responseJSON.results;
                    fillTable(res.responseJSON.results);
                },
            });
        }
        

        function fillTable(_links) {
            var linktable = $('#linktable')[0];
            linktable.innerHTML = '';

            function setClipboardText(text){
                var id = 'mycustom-clipboard-textarea-hidden-id';
                var existsTextarea = document.getElementById(id);

                if (!existsTextarea){
                    var textarea = document.createElement('textarea');
                    textarea.id = id;
                    textarea.style.position = 'fixed';
                    textarea.style.top = 0;
                    textarea.style.left = 0;
                    textarea.style.width = '1px';
                    textarea.style.height = '1px';
                    textarea.style.padding = 0;
                    textarea.style.border = 'none';
                    textarea.style.outline = 'none';
                    textarea.style.boxShadow = 'none';
                
                    textarea.style.background = 'transparent';
                    document.querySelector('body').appendChild(textarea);
                    existsTextarea = document.getElementById(id);
                }
            
                existsTextarea.value = text;
                existsTextarea.select();
            
                try {
                    var status = document.execCommand('copy');
                    if (!status){
                        window.alert('Could not copy shortlink to clipboard.');
                    } else {
                        window.alert('Shortlink copied to clipboard.');
                    }
                } catch (err) {
                    window.alert('Could not copy shortlink to clipboard.');
                }
            }

            _links.forEach(l => {
                var row = document.createElement('tr');

                var frootlink = document.createElement('td');
                frootlink.innerHTML = `<a href="${l.root_link}" target="_blank">${l.root_link}</a>`;
                row.appendChild(frootlink);

                var fshortlink = document.createElement('td');
                fshortlink.innerHTML = `<a href="javascript:{}">${l.short_link}</a>`;
                fshortlink.onclick = () => {
                    setClipboardText(window.location.origin + '/' + l.short_link);
                };
                row.appendChild(fshortlink);

                var fcreated = document.createElement('td');
                fcreated.innerHTML = l.created;
                row.appendChild(fcreated);

                var faccesses = document.createElement('td');
                faccesses.innerHTML = l.accesses;
                row.appendChild(faccesses);

                var flastaccess = document.createElement('td');
                flastaccess.innerHTML = l.edited;
                row.appendChild(flastaccess);

                var fremove = document.createElement('td');
                var btremove = document.createElement('button');
                btremove.className = 'button';
                btremove.innerText = 'REMOVE';
                btremove.onclick = function() {
                    $.ajax({
                        method: 'DELETE',
                        url: `/api/shortlinks/${l.id}`,
                        complete: function(res) {
                            console.log(res);
                            if (res.status != 200) {
                                window.alert(`Deletion failed:\nCode: ${res.responseJSON.code}\nMessage: ${res.responseJSON.message}`)
                                return;
                            }

                            loadEntries();
                        }
                    });
                };
                fremove.appendChild(btremove);
                row.appendChild(fremove);

                linktable.appendChild(row);
            });
        };

        loadEntries();
        
        // --------------------

        $('#fcreateedit').submit(function(e) {
            e.preventDefault();

            var long = $('#tblong').val();
            var short = $('#tbshort').val();

            if (long.length < 6) {
                window.alert('Long Link entry invalid.');
                return;
            }

            var eLink = links.find(function(l) {
                return l.short_link == short;
            });

            var url = '/api/shortlinks';

            if (eLink)
                url += '/' + eLink.id;

            $.ajax({
                method: 'POST',
                url: url,
                contentType: 'application/json',
                data: JSON.stringify({
                    'root_link': long,
                    'short_link': short,
                }),
                complete: function(res) {
                    if (res.status != 200) {
                        window.alert(`Deletion failed:\nCode: ${res.responseJSON.code}\nMessage: ${res.responseJSON.message}`)
                        return;
                    }

                    loadEntries();
                },
            });
        })

    </script>

</body>

</html>